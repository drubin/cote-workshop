# Project defnition and list of possible environments 
project:
  name: cote-workshop
  environments:
    - name: local
      providers:
        - name: local-kubernetes
        
# Module defintion
module:
  description: cote-workshop
  type: container
  name: cote-workshop
  # List of deployments
  services:
    - name: admin
      # We have to auto inject `DISCOVERY_HOSTNAME` to the value of `POD_IP` which garden injects
      command: ["/bin/sh", "-c", "DISCOVERY_HOSTNAME=$POD_IP node admin/server.js"]
      env:
        PG: true
        COTE_DISCOVERY_REDIS_HOST: redis
      dependencies:
        - postgres
        - redis
      ports:
        - name: http
          containerPort: 5000
      # Public exposed endpoints via the lb
      ingresses:
        - path: /
          port: http
          hostname: admin.cote-workshop.local.app.garden

    - name: end-user
      command: ["/bin/sh", "-c", "DISCOVERY_HOSTNAME=$POD_IP node end-user/server.js"]
      env:
        PG: true
        COTE_DISCOVERY_REDIS_HOST: redis
      dependencies:
        - postgres
        - redis
      ports:
        - name: http
          containerPort: 5001
      # Public exposed endpoints via the lb
      ingresses:
        - path: /
          port: http
      
    - name: monitoring
      command: ["/bin/sh", "-c", "DISCOVERY_HOSTNAME=$POD_IP node monitor.js"]
      env:
        PG: true
        COTE_DISCOVERY_REDIS_HOST: redis
      dependencies:
        - postgres
        - redis
      ports:
        - name: http
          containerPort: 5555
      # Public exposed endpoints via the lb
      ingresses:
        - path: /
          port: http
          hostname: monitor.cote-workshop.local.app.garden

    - name: payment-service
      command: ["/bin/sh", "-c", "DISCOVERY_HOSTNAME=$POD_IP node services/payment-service.js"]
      dependencies:
        - postgres
        - redis
      env:
        PG: true
        COTE_DISCOVERY_REDIS_HOST: redis
    
    - name: product-service
      command: ["/bin/sh", "-c", "DISCOVERY_HOSTNAME=$POD_IP node services/product-service.js"]
      dependencies:
        - postgres
        - redis
      env:
        PG: true
        COTE_DISCOVERY_REDIS_HOST: redis

    - name: purchase-service
      command: ["/bin/sh", "-c", "DISCOVERY_HOSTNAME=$POD_IP node services/purchase-service.js"]
      dependencies:
        - postgres
        - redis
      env:
        PG: true
        COTE_DISCOVERY_REDIS_HOST: redis

    - name: user-service
      command: ["/bin/sh", "-c", "DISCOVERY_HOSTNAME=$POD_IP node services/user-service.js"]
      dependencies:
        - postgres
        - redis
      env:
        PG: true
        COTE_DISCOVERY_REDIS_HOST: redis

    - name: fixture
      command: ["/bin/sh", "-c", "DISCOVERY_HOSTNAME=$POD_IP node init-db.js"]
      dependencies:
        - postgres
      env:
        PG: true
        COTE_DISCOVERY_REDIS_HOST: redis
